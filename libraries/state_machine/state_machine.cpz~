#include "state_machine.h"
#include "button.h"
#include "utils.h"
#include <inttypes.h>

StateMachine::StateMachine(uint8_t onOffBtnPin, uint8_t rightBtnPin, uint8_t upBtnPin, uint8_t downBtnPin, uint8_t setBtnPin) {
  _currentState = AppStates::STATE_MAIN;
  _onOffExit = new Button(onOffBtnPin);
  _right = new Button(rightBtnPin);
  _up = new Button(upBtnPin);
  _down = new Button(downBtnPin);
  _set = new Button(setBtnPin);
}

StateMachine::~StateMachine() {
  delete _onOffExit;
  delete _right;
  delete _up;
  delete _down;
  delete _set;
}

void StateMachine::setPIDControl(PIDControl* pid) {
  _pid = pid;
}

void StateMachine::process(void) {
  _onOffExit->process();
  _right->process();
  _up->process();
  _down->process();
  _set->process();

  // Pressed the 'up' button
  if (_up->pushed()) {
    _up_pressed_since = millis();
  } else if (_down->pushed()) {
    _down_pressed_since = millis();
  }

  switch (_currentState) {
  case AppStates::STATE_MAIN:
    processMainState();
    break;
  case AppStates::STATE_SET_TEMP:
    processSetTempState();
    break;
  case AppStates::STATE_AUTOTUNE:
    processAutoTuneState();
    break;
  case AppStates::STATE_SET_KP:
    processSetKpState();
    break;
  case AppStates::STATE_SET_KI:
    processSetKiState();
    break;
  case AppStates::STATE_SET_KD:
    processSetKdState();
    break;
  default:
    _currentState = AppStates::STATE_MAIN;
    break;
  }

  this->updateDisplay();
}

void StateMachine::updateDisplay() {
  _lcd->setCursor(0, 1);

  switch (_currentState) {
  case AppStates::STATE_MAIN:
    _lcd->print("Temp: " + Utils::floatToStr(_pid->getCurrentTemp()));
    _lcd->setCursor(0, 2);
    _lcd->print("Tgt: " + Utils::floatToStr(_pid->getTargetTemp()));
    _lcd->setCursor(0, 3);
    _lcd->print("State: " + _pid->getStateStr());
    break;
  case AppStates::STATE_SET_TEMP:
    processSetTempState();
    break;
  case AppStates::STATE_AUTOTUNE:
    processAutoTuneState();
    break;
  case AppStates::STATE_SET_KP:
    processSetKpState();
    break;
  case AppStates::STATE_SET_KI:
    processSetKiState();
    break;
  case AppStates::STATE_SET_KD:
    processSetKdState();
    break;
  default:
    _currentState = AppStates::STATE_MAIN;
    break;
  }
 
}

void StateMachine::processMainState() {
  // If pressed the on/off button
  if (_onOffExit->pushed()) {
    int pidState = _pid->getState();

    // If already off, turn on. If on, turn off.
    // Ignore any other states (e.g. don't interrupt auto tuning)
    if (pidState == PIDState::OFF) {
      _pid->turnOn();
    } else if (pidState == PIDState::ON) {
      _pid->turnOff();
    }
  } else {
    // If pressed the -> button, change to next state (set temperature)
    if (_right->pushed()) {
      _stateValDbl = _pid->getTargetTemp();
      _currentState = AppStates::STATE_SET_TEMP;
    }
  }
}

void StateMachine::processSetTempState() {
  if (_onOffExit->pushed()) { // Exit back to main state
    _currentState = AppStates::STATE_MAIN;
    return;
  }

  // Jumped to the AutoTune state ?
  if (_right->pushed()) {
    _stateValBool = _pid->getState() == PIDState::AUTOTUNE;
    _currentState = AppStates::STATE_AUTOTUNE;
    return;
  }

  // Increasing temperature
  if (isPressed(_up, _up_pressed_since)) {
    _stateValDbl += 1.0;
    return;
  }

  // Lowering temperature
  if (isPressed(_down, _down_pressed_since)) {
    _stateValDbl -= 1.0;
    return;
  }

  // Set temperature
  if (_set->pushed()) {
    _pid->setTargetTemp(_stateValDbl);
    _currentState = AppStates::STATE_MAIN;
  }
}

void StateMachine::processAutoTuneState() {
  if (_pid->getState() == PIDState::AUTOTUNE) {
    // Display the "RUNNING" message here
    if (_onOffExit->pushed()) {
      _currentState = AppStates::STATE_MAIN;
      return;
    }
    if (_right->pushed()) {
      _stateValDbl = _pid->getKp();
      _currentState = AppStates::STATE_SET_KP;
      return;
    }
  } else {
    if (isPressed(_up, _up_pressed_since) || isPressed(_down, _down_pressed_since)) {
      _stateValBool = !_stateValBool;
      return;
    }

    if (_set->pushed()) {
      _pid->autoTune();
      _currentState = AppStates::STATE_MAIN;
      return;
    }
  }
}

void StateMachine::processSetKpState() {
  if (_onOffExit->pushed()) { // Exit back to main state
    _currentState = AppStates::STATE_MAIN;
    return;
  }

  // Jumped to the Set Ki state?
  if (_right->pushed()) {
    _stateValDbl = _pid->getKi();
    _currentState = AppStates::STATE_SET_KI;
    return;
  }

  // Increasing Kp
  if (isPressed(_up, _up_pressed_since)) {
    _stateValDbl += 1.0;
    return;
  }

  // Lowering Kp
  if (isPressed(_down, _down_pressed_since)) {
    _stateValDbl -= 1.0;
    return;
  }

  // Set Kp
  if (_set->pushed()) {
    _pid->setKp(_stateValDbl);
    _currentState = AppStates::STATE_MAIN;
  }
}

void StateMachine::processSetKiState() {
  if (_onOffExit->pushed()) { // Exit back to main state
    _currentState = AppStates::STATE_MAIN;
    return;
  }

  // Jumped to the Set Kd state?
  if (_right->pushed()) {
    _stateValDbl = _pid->getKd();
    _currentState = AppStates::STATE_SET_KD;
    return;
  }

  // Increasing Ki
  if (isPressed(_up, _up_pressed_since)) {
    _stateValDbl += 1.0;
    return;
  }

  // Lowering Ki
  if (isPressed(_down, _down_pressed_since)) {
    _stateValDbl -= 1.0;
    return;
  }

  // Set Ki
  if (_set->pushed()) {
    _pid->setKi(_stateValDbl);
    _currentState = AppStates::STATE_MAIN;
  }
}

void StateMachine::processSetKdState() {
  if (_onOffExit->pushed()) { // Exit back to main state
    _currentState = AppStates::STATE_MAIN;
    return;
  }

  // Jumped to the main state?
  if (_right->pushed()) {
    _currentState = AppStates::STATE_MAIN;
    return;
  }

  // Increasing Kd
  if (isPressed(_up, _up_pressed_since)) {
    _stateValDbl += 1.0;
    return;
  }

  // Lowering Kd
  if (isPressed(_down, _down_pressed_since)) {
    _stateValDbl -= 1.0;
    return;
  }

  // Set Kd
  if (_set->pushed()) {
    _pid->setKd(_stateValDbl);
    _currentState = AppStates::STATE_MAIN;
  }
}

bool StateMachine::isPressed(Button* btn, unsigned long &pressedSince) {
  bool isPressed = btn->pushed() || (btn->isPressed() && ((millis() - pressedSince) > 300));
  if (isPressed) {
    pressedSince = millis();
  }

  return isPressed;
}
